version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.5.3-stretch-node
    executor: ruby/default
    steps:
      - checkout
      - ruby/with-cache:
        steps:
          - run: rails db: {create,migrate}
          - run: rspec
          - run:
                name: Installing deployment dependencies
                command: |
                  sudo apt-get -y -qq update
                  sudo apt-get install python-pip python-dev build-essential
                  sudo pip install --upgrade setuptools
                  sudo pip install awsebcli --upgrade
          - run:
            name: Deploying
            command: eb deploy Kiddoapi-prod

    workflows:
      build-and-test:
        jobs:
          - build-and-test:
              context: aws
              filters:
                branches:
                  only:
                    - main
